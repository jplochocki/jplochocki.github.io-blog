<!doctype html><html lang=pl itemscope itemtype=http://schema.org/WebPage>
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KETRV3SXRJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-KETRV3SXRJ')</script>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<title>PyConnect i pliki - /home/systemik/blog</title>
<meta name=description content="W poprzednim poście
opisałem nawiązywanie połączenia z KDEConnect
(przy wykorzystaniu danych z GSConnect).
Teraz czas na przedstawienie, jak działa jedna z najbardziej podstawowych
funkcjonalności tego protokołu - czyli możliwość przesyłania plików. A możemy
je odbierać, jak i wysyłać."><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"\/home\/systemik\/blog","url":"https:\/\/jplochocki.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/jplochocki.github.io\/"}</script>
<script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/jplochocki.github.io\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/jplochocki.github.io\/post\/2022-02-20-pyconnect-i-pliki\/","name":"Py connect i pliki"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":""},"headline":"PyConnect i pliki","description":"W poprzednim poście opisałem nawiązywanie połączenia z KDEConnect (przy wykorzystaniu danych z GSConnect). Teraz czas na przedstawienie, jak działa jedna z najbardziej podstawowych funkcjonalności tego protokołu - czyli możliwość przesyłania plików. A możemy je odbierać, jak i wysyłać.\n","inLanguage":"pl","wordCount":950,"datePublished":"2022-02-20T08:47:44","dateModified":"2022-02-20T08:47:44","image":"https:\/\/jplochocki.github.io\/","keywords":["KDEConnect, GSConnect, Python, SSL, TLS, AnyIO"],"mainEntityOfPage":"https:\/\/jplochocki.github.io\/post\/2022-02-20-pyconnect-i-pliki\/","publisher":{"@type":"Organization","name":"https:\/\/jplochocki.github.io\/","logo":{"@type":"ImageObject","url":"https:\/\/jplochocki.github.io\/","height":60,"width":60}}}</script>
<meta property="og:title" content="PyConnect i pliki">
<meta property="og:description" content="W poprzednim poście
opisałem nawiązywanie połączenia z KDEConnect
(przy wykorzystaniu danych z GSConnect).
Teraz czas na przedstawienie, jak działa jedna z najbardziej podstawowych
funkcjonalności tego protokołu - czyli możliwość przesyłania plików. A możemy
je odbierać, jak i wysyłać.">
<meta property="og:url" content="https://jplochocki.github.io/post/2022-02-20-pyconnect-i-pliki/">
<meta property="og:type" content="website">
<meta property="og:site_name" content="/home/systemik/blog">
<meta name=twitter:title content="PyConnect i pliki">
<meta name=twitter:description content="W poprzednim poście
opisałem nawiązywanie połączenia z KDEConnect
(przy wykorzystaniu danych z GSConnect).
Teraz czas na przedstawienie, jak działa jedna z najbardziej podstawowych
funkcjonalności …">
<meta name=twitter:card content="summary">
<meta name=generator content="Hugo 0.92.2">
<link rel=alternate href=https://jplochocki.github.io/index.xml type=application/rss+xml title=/home/systemik/blog><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous>
<link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous>
<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://jplochocki.github.io/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://jplochocki.github.io/css/syntax.css><link rel=stylesheet href=https://jplochocki.github.io/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top navbar-custom">
<div class=container-fluid>
<div class=navbar-header>
<button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Nawigacja</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://jplochocki.github.io/>/home/systemik/blog</a>
</div>
<div class="collapse navbar-collapse" id=main-navbar>
<ul class="nav navbar-nav navbar-right">
</ul>
</div>
</div>
</nav>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header class=header-section>
<div class="intro-header no-img">
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<div class=post-heading>
<h1>PyConnect i pliki</h1>
<span class=post-meta>
<i class="fas fa-calendar"></i>&nbsp;Opublikowany 20.02.2022
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;
</span>
</div>
</div>
</div>
</div>
</div>
</header>
<div class=container role=main>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<article role=main class=blog-post>
<p>W <a href=https://jplochocki.github.io/post/2022-02-06-pyconnect-na-plecach-gsconnect/>poprzednim poście</a>
opisałem nawiązywanie połączenia z <a href="https://play.google.com/store/apps/details?id=org.kde.kdeconnect_tp&hl=pl&gl=US">KDEConnect</a>
(przy wykorzystaniu danych z <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect>GSConnect</a>).
Teraz czas na przedstawienie, jak działa jedna z najbardziej podstawowych
funkcjonalności tego protokołu - czyli możliwość przesyłania plików. A możemy
je odbierać, jak i <a href=#wysyłanie-plików>wysyłać</a>.</p>
<h2 id=odbieranie-plików>Odbieranie plików</h2>
<div style=float:right;width:410px>
<p><img src=/2022-02-20-pyconnect-i-pliki-1.jpg alt="KDE Connect i wysyłanie plików"></p>
</div>
<p>Odbieranie plików inicjuje oczywiście <a href="https://play.google.com/store/apps/details?id=org.kde.kdeconnect_tp&hl=pl&gl=US">KDEConnect</a>.
Z dostępnych opcji wybieramy &ldquo;<strong>Wysyłanie plików</strong>&rdquo; (pojawi się dialog wyboru
plików, z którego możemy wybrać jeden lub więcej plików do przesłania).</p>
<p><a href="https://play.google.com/store/apps/details?id=org.kde.kdeconnect_tp&hl=pl&gl=US">KDEConnect</a>
w takiej sytuacji wysyła do naszego urządzenia pakiet <code>kdeconnect.share.request</code>
zawierający w <code>body</code> informacje o pliku, jak jego nazwa - <code>filename</code>.
W kwestii rozmiaru pliku, korzystamy z <code>payloadSize</code> z poza <code>body</code>.</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>1645343489598</span>,
    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;kdeconnect.share.request&#34;</span>,
    <span style=color:#f92672>&#34;body&#34;</span>:{
        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;Screenshot_2022-02-07-23-30-00-849_com.facebook.lite.jpg&#34;</span>,
        <span style=color:#f92672>&#34;lastModified&#34;</span>: <span style=color:#ae81ff>1644273001000</span>,
        <span style=color:#f92672>&#34;numberOfFiles&#34;</span>: <span style=color:#ae81ff>2</span>,
        <span style=color:#f92672>&#34;totalPayloadSize&#34;</span>: <span style=color:#ae81ff>310309</span>
    },
    <span style=color:#f92672>&#34;payloadSize&#34;</span>: <span style=color:#ae81ff>260509</span>,
    <span style=color:#f92672>&#34;payloadTransferInfo&#34;</span>: {
        <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>1739</span>
    }
}
</code></pre></td></tr></table>
</div>
</div><p>Transfer pliku nie jest prowadzony w tym samym połączeniu, które przesyła nam
pakiety, ale w nowym połączeniu, które powinniśmy nawiązać z <a href="https://play.google.com/store/apps/details?id=org.kde.kdeconnect_tp&hl=pl&gl=US">KDEConnect</a>
na porcie podanym w <code>payloadTransferInfo.port</code> (numer portu będzie pomiędzy
<code>1739</code> a <code>1764</code>).</p>
<p>W przypadku wysyłania wielu plików - będziemy mieli przesyłane kolejne pakiety
<code>kdeconnect.share.request</code> (następny po zakończeniu pobierania pliku wskazanego
przez poprzedni pakiet). Na wysyłanie wielu plików wskazują nam pola
<code>body.numberOfFiles</code> (ilość plików przesyłanych) i <code>body.totalPayloadSize</code> (suma
wielkości wszystkich plików; <code>payloadSize</code> to wielkość pojedynczego pliku). Np.
następny plik po tym będzie miał następujący pakiet <code>kdeconnect.share.request</code>:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>1645343489646</span>,
    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;kdeconnect.share.request&#34;</span>,
    <span style=color:#f92672>&#34;body&#34;</span>:{
        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;Screenshot_2022-02-20-08-51-10-065_org.kde.kdeconnect_tp.jpg&#34;</span>,
        <span style=color:#f92672>&#34;lastModified&#34;</span>: <span style=color:#ae81ff>1645343471000</span>,
        <span style=color:#f92672>&#34;numberOfFiles&#34;</span>: <span style=color:#ae81ff>2</span>,
        <span style=color:#f92672>&#34;totalPayloadSize&#34;</span>: <span style=color:#ae81ff>310309</span>
    },
    <span style=color:#f92672>&#34;payloadSize&#34;</span>: <span style=color:#ae81ff>49800</span>,
    <span style=color:#f92672>&#34;payloadTransferInfo&#34;</span>: {
        <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>1739</span>
    }
}
</code></pre></td></tr></table>
</div>
</div><p>Po teorii - czas na praktykę. W przedstawionym kodzie <a href=https://gist.github.com/jplochocki/1a7a206ae7e2b0f2243b1fa473b31003>pyconnect.py</a>
odbieranie pakietu <code>kdeconnect.share.request</code> odbywa się w funkcji
<code>device_connection_task()</code> (odpowiedzialnej po nawiązaniu połączenia, za
przetwarzanie pakietów przychodzących)</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>device_connection_task</span>(id_packet, remote_ip):
    <span style=color:#75715e># ...</span>
        <span style=color:#75715e># receiving packets</span>
        bssock <span style=color:#f92672>=</span> BufferedByteReceiveStream(ssock)
        <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> anyio<span style=color:#f92672>.</span>create_task_group() <span style=color:#66d9ef>as</span> slave_group:
            <span style=color:#75715e># ...</span>

            <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
                pack_data <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> bssock<span style=color:#f92672>.</span>receive_until(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>, <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span>)

                <span style=color:#66d9ef>try</span>:
                    pack <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(pack_data)
                <span style=color:#66d9ef>except</span> json<span style=color:#f92672>.</span>JSONDecodeError:
                    log<span style=color:#f92672>.</span>exception(
                        (<span style=color:#e6db74>&#39;device_connection_task(): Error while decoding &#39;</span>
                         <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;packet / </span><span style=color:#e6db74>{</span>pack_data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>))
                    <span style=color:#66d9ef>continue</span>
                log<span style=color:#f92672>.</span>debug(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;device_connection_task(): Packet </span><span style=color:#e6db74>{</span>pack_data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)

                <span style=color:#66d9ef>if</span> pack[<span style=color:#e6db74>&#39;type&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;kdeconnect.share.request&#39;</span>:
                    slave_group<span style=color:#f92672>.</span>start_soon(download_file_task, pack, remote_ip,
                                           ssl_context)
</code></pre></td></tr></table>
</div>
</div><p>Przy pojawieniu się pakietu z plikiem - przechodzimy do funkcji
<code>download_file_task()</code> (wywoływanej jako oddzielne zadanie). Funkcja ta musi:</p>
<ul>
<li>Sprawdzić poprawność pakietu (pola <code>body.filename</code>, <code>payloadSize</code> i
<code>payloadTransferInfo.port</code> są wymagane). Linie <code>4</code> - <code>12</code>.</li>
<li>Przygotować nazwę pliku docelowego (linie <code>14</code> - <code>21</code>).</li>
<li>Nawiązać połączenie z <a href="https://play.google.com/store/apps/details?id=org.kde.kdeconnect_tp&hl=pl&gl=US">KDEConnect</a>
na porcie wskazanym przez <code>payloadTransferInfo.port</code> (linie <code>25</code> - <code>27</code>).</li>
<li>Pobrać plik (zakończenie połączenia nastąpi automatycznie po odebraniu
ostatnich danych). Linie <code>29</code> - <code>39</code>.</li>
</ul>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>download_file_task</span>(pack, remote_ip, ssl_context):
    log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;download_file_task() from </span><span style=color:#e6db74>{</span>remote_ip<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)

    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;filename&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> pack[<span style=color:#e6db74>&#39;body&#39;</span>]:
        log<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#39;download_file_task(): No filename property in pack.&#39;</span>)
        <span style=color:#66d9ef>return</span>

    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;payloadSize&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> pack <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;payloadTransferInfo&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> pack \
            <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;port&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> pack[<span style=color:#e6db74>&#39;payloadTransferInfo&#39;</span>]:
        log<span style=color:#f92672>.</span>error((<span style=color:#e6db74>&#39;download_file_task(): No payloadSize or &#39;</span>
                   <span style=color:#e6db74>&#39;payloadTransferInfo property in pack.&#39;</span>))
        <span style=color:#66d9ef>return</span>

    <span style=color:#75715e># dest filename</span>
    filename <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>expanduser(<span style=color:#e6db74>&#39;~&#39;</span>), pack[<span style=color:#e6db74>&#39;body&#39;</span>][<span style=color:#e6db74>&#39;filename&#39;</span>])
    i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
    <span style=color:#66d9ef>while</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(filename):
        filename <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>splitext(pack[<span style=color:#e6db74>&#39;body&#39;</span>][<span style=color:#e6db74>&#39;filename&#39;</span>])
        filename <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>expanduser(<span style=color:#e6db74>&#39;~&#39;</span>),
                                <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>filename[<span style=color:#ae81ff>0</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>-</span><span style=color:#e6db74>{</span>i<span style=color:#e6db74>}{</span>filename[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
        i <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
    log<span style=color:#f92672>.</span>debug(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;download_file_task(): destination file: </span><span style=color:#e6db74>{</span>filename<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)

    <span style=color:#75715e># download</span>
    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> <span style=color:#66d9ef>await</span> anyio<span style=color:#f92672>.</span>connect_tcp(
            remote_ip, pack[<span style=color:#e6db74>&#39;payloadTransferInfo&#39;</span>][<span style=color:#e6db74>&#39;port&#39;</span>],
            ssl_context<span style=color:#f92672>=</span>ssl_context) <span style=color:#66d9ef>as</span> sock:

        <span style=color:#66d9ef>with</span> open(filename, <span style=color:#e6db74>&#39;wb&#39;</span>) <span style=color:#66d9ef>as</span> f:
            received <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
            <span style=color:#66d9ef>while</span> received <span style=color:#f92672>&lt;</span> pack[<span style=color:#e6db74>&#39;payloadSize&#39;</span>]:
                data <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> sock<span style=color:#f92672>.</span>receive()
                f<span style=color:#f92672>.</span>write(data)
                received <span style=color:#f92672>+=</span> len(data)
                print((<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>* download_file_task(): </span><span style=color:#e6db74>{</span>pack[<span style=color:#e6db74>&#34;body&#34;</span>][<span style=color:#e6db74>&#34;filename&#34;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>
                       <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39; - received bytes  +</span><span style=color:#e6db74>{</span>len(data)<span style=color:#e6db74>}</span><span style=color:#e6db74> (</span><span style=color:#e6db74>{</span>received<span style=color:#e6db74>}</span><span style=color:#e6db74> of&#39;</span>
                       <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39; </span><span style=color:#e6db74>{</span>pack[<span style=color:#e6db74>&#34;payloadSize&#34;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>)&#39;</span>),
                      end<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>)
        print(<span style=color:#e6db74>&#39;&#39;</span>)

    log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#39;download_file_task(): download connection closed.&#39;</span>)
</code></pre></td></tr></table>
</div>
</div><h2 id=wysyłanie-plików>Wysyłanie plików</h2>
<p>Wysyłanie plików do <a href="https://play.google.com/store/apps/details?id=org.kde.kdeconnect_tp&hl=pl&gl=US">KDEConnect</a>
przebiega bardzo podobnie do ich odbierania - też korzystamy z pakietu
<code>kdeconnect.share.request</code>, ale to my go układamy i wysyłamy. I my też musimy
(po określeniu, który port w zakresie pomiędzy <code>1739</code> a <code>1764</code> jest wolny)
otworzyć serwer wysyłania pliku. Jeśli zostanie na nim nawiązane połączenie -
wysyłamy plik i kończymy działanie serwera.</p>
<p>W mojej implementacji <a href=https://gist.github.com/jplochocki/1a7a206ae7e2b0f2243b1fa473b31003>pyconnect.py</a>
wykonywane było testowe wysyłanie pliku - uruchamiane jest nowe zadanie
(<code>slave_group.start_soon(test_upload_task, ssock, ssl_context)</code>),
które w dwie sekundy po starcie wysyła plik kodu <code>pyconnect.py</code> na urządzenie.</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_upload_task</span>(ssock, ssl_context):
    <span style=color:#e6db74>&#39;&#39;&#39;
</span><span style=color:#e6db74>    Test upload task - upload script itself
</span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
    <span style=color:#66d9ef>await</span> anyio<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>2</span>)
    <span style=color:#66d9ef>await</span> upload_file(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>abspath(__file__), ssock, ssl_context)


<span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>upload_file</span>(file_path, ssock, ssl_context):
    log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;upload_file(): </span><span style=color:#e6db74>{</span>file_path<span style=color:#e6db74>=}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{</span>ssock<span style=color:#e6db74>=}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{</span>ssl_context<span style=color:#e6db74>=}</span><span style=color:#e6db74>&#39;</span>)

    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(file_path):
        log<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;upload_file(): File not exists (</span><span style=color:#e6db74>{</span>file_path<span style=color:#e6db74>}</span><span style=color:#e6db74>)&#39;</span>)
        <span style=color:#66d9ef>return</span>

    <span style=color:#75715e># start upload server</span>
    file_size <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>getsize(file_path)
    server <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
    close_server_event <span style=color:#f92672>=</span> anyio<span style=color:#f92672>.</span>Event()

    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_connection</span>(sock_client):
        <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> sock_client:
            <span style=color:#66d9ef>with</span> open(file_path, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> f:
                sent <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
                <span style=color:#66d9ef>while</span> sent <span style=color:#f92672>&lt;</span> file_size:
                    data <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>63</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span>)
                    <span style=color:#66d9ef>await</span> sock_client<span style=color:#f92672>.</span>send(data)

                    sent <span style=color:#f92672>+=</span> len(data)
                    print((<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>upload_file() sent </span><span style=color:#e6db74>{</span>sent<span style=color:#e6db74>}</span><span style=color:#e6db74> of </span><span style=color:#e6db74>{</span>file_size<span style=color:#e6db74>}</span><span style=color:#e6db74> &#39;</span>
                           <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;(+</span><span style=color:#e6db74>{</span>len(data)<span style=color:#e6db74>}</span><span style=color:#e6db74>)&#39;</span>), end<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>)
        print(<span style=color:#e6db74>&#39;&#39;</span>)

        <span style=color:#66d9ef>await</span> server<span style=color:#f92672>.</span>aclose()
        close_server_event<span style=color:#f92672>.</span>set()

    transfer_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
    <span style=color:#66d9ef>for</span> port <span style=color:#f92672>in</span> range(KDE_CONNECT_TRANSFER_MIN, KDE_CONNECT_TRANSFER_MAX <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
        <span style=color:#66d9ef>try</span>:
            server <span style=color:#f92672>=</span> TLSListener(<span style=color:#66d9ef>await</span> anyio<span style=color:#f92672>.</span>create_tcp_listener(
                local_port<span style=color:#f92672>=</span>port, local_host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;0.0.0.0&#39;</span>),
                ssl_context<span style=color:#f92672>=</span>ssl_context, standard_compatible<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
            log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;upload_file(): - Selected port </span><span style=color:#e6db74>{</span>port<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
            transfer_port <span style=color:#f92672>=</span> port

            <span style=color:#66d9ef>break</span>
        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>OSError</span> <span style=color:#66d9ef>as</span> e:
            <span style=color:#66d9ef>if</span> e<span style=color:#f92672>.</span>errno <span style=color:#f92672>==</span> <span style=color:#ae81ff>98</span>:  <span style=color:#75715e># port already in use</span>
                <span style=color:#66d9ef>continue</span>
            <span style=color:#66d9ef>raise</span> e

    <span style=color:#75715e># send ready packet</span>
    pack <span style=color:#f92672>=</span> {
        <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;kdeconnect.share.request&#39;</span>,
        <span style=color:#e6db74>&#39;body&#39;</span>: {
            <span style=color:#e6db74>&#39;filename&#39;</span>: os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>basename(file_path),
            <span style=color:#e6db74>&#39;open&#39;</span>: <span style=color:#66d9ef>False</span>,
            <span style=color:#e6db74>&#39;lastModified&#39;</span>: int(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>getmtime(file_path)),
            <span style=color:#e6db74>&#39;numberOfFiles&#39;</span>: <span style=color:#ae81ff>1</span>,
            <span style=color:#e6db74>&#39;totalPayloadSize&#39;</span>: file_size
        },
        <span style=color:#e6db74>&#39;payloadSize&#39;</span>: file_size,
        <span style=color:#e6db74>&#39;payloadTransferInfo&#39;</span>: {
            <span style=color:#e6db74>&#39;port&#39;</span>: transfer_port
        }
    }

    serve_forever <span style=color:#f92672>=</span> server<span style=color:#f92672>.</span>serve(handle_connection)
    <span style=color:#66d9ef>await</span> anyio<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>0.01</span>)

    <span style=color:#66d9ef>await</span> ssock<span style=color:#f92672>.</span>send(prepare_to_send(pack))
    log<span style=color:#f92672>.</span>debug(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;upload_file(): invitation packet sent: </span><span style=color:#e6db74>{</span>pack<span style=color:#e6db74>!r}</span><span style=color:#e6db74>&#39;</span>)

    <span style=color:#66d9ef>try</span>:
        <span style=color:#66d9ef>await</span> serve_forever
    <span style=color:#66d9ef>except</span> anyio<span style=color:#f92672>.</span>ClosedResourceError:
        close_server_event<span style=color:#f92672>.</span>set()

    <span style=color:#66d9ef>await</span> close_server_event<span style=color:#f92672>.</span>wait()
    log<span style=color:#f92672>.</span>debug(<span style=color:#e6db74>&#39;upload_file(): transfer server closed&#39;</span>)
</code></pre></td></tr></table>
</div>
</div><hr>
<p>W następnym poście zajmę się wysyłaniem i odbieraniem <code>SMS-ów</code>.</p>
<div class=blog-tags>
<a href=https://jplochocki.github.io//tags/kdeconnect/>KDEConnect</a>&nbsp;
<a href=https://jplochocki.github.io//tags/gsconnect/>GSConnect</a>&nbsp;
<a href=https://jplochocki.github.io//tags/python/>Python</a>&nbsp;
<a href=https://jplochocki.github.io//tags/ssl/>SSL</a>&nbsp;
<a href=https://jplochocki.github.io//tags/tls/>TLS</a>&nbsp;
<a href=https://jplochocki.github.io//tags/anyio/>AnyIO</a>&nbsp;
</div>
</article>
<ul class="pager blog-pager">
<li class=previous>
<a href=https://jplochocki.github.io/post/2022-02-06-pyconnect-na-plecach-gsconnect/ data-toggle=tooltip data-placement=top title="PyConnect na plecach GSConnect">&larr; Poprzedni</a>
</li>
</ul>
</div>
</div>
</div>
<footer>
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<ul class="list-inline text-center footer-links">
</ul>
<p class="credits copyright text-muted">
&nbsp;&bull;&nbsp;&copy;
2022
&nbsp;&bull;&nbsp;
<a href=https://jplochocki.github.io/>/home/systemik/blog</a>
</p>
<p class="credits theme-by text-muted">
<a href=https://gohugo.io>Hugo v0.92.2</a> napędzany &nbsp;&bull;&nbsp; Motyw <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> przystosowany od <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>
</p>
</div>
</div>
</div>
</footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script>
<script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://jplochocki.github.io/js/main.js></script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://jplochocki.github.io/js/load-photoswipe.js></script>
</body>
</html>