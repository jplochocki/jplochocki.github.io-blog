<!doctype html><html lang=pl itemscope itemtype=http://schema.org/WebPage>
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KETRV3SXRJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-KETRV3SXRJ')</script>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<title>PyConnect na plecach GSConnect - /home/systemik/blog</title>
<meta name=description content="Mniej więcej na początku grudnia zainteresowałem się protokołem KDEConnect. Aplikacji tej używałem już od ponad roku - dobrze służyła mi do synchronizacji plików pomiędzy telefonem i komputerem. Coraz bardziej marzyła mi się własna wersja - po stronie komputera. Planowałem jej integrację z własnymi aplikacjami (np. automatyzację pobierania i tagowania nowych zdjęć z moich podróży)."><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"\/home\/systemik\/blog","url":"https:\/\/jplochocki.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/jplochocki.github.io\/"}</script>
<script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/jplochocki.github.io\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/jplochocki.github.io\/post\/2022-02-06-pyconnect-na-plecach-gsconnect\/","name":"Py connect na plecach gsconnect"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":""},"headline":"PyConnect na plecach GSConnect","description":"Mniej więcej na początku grudnia zainteresowałem się protokołem KDEConnect. Aplikacji tej używałem już od ponad roku - dobrze służyła mi do synchronizacji plików pomiędzy telefonem i komputerem. Coraz bardziej marzyła mi się własna wersja - po stronie komputera. Planowałem jej integrację z własnymi aplikacjami (np. automatyzację pobierania i tagowania nowych zdjęć z moich podróży).\n","inLanguage":"pl","wordCount":1416,"datePublished":"2022-02-06T15:00:22","dateModified":"2022-02-06T15:00:22","image":"https:\/\/jplochocki.github.io\/","keywords":["KDEConnect, GSConnect, Python, SSL, TLS, AnyIO, Gnome Shell"],"mainEntityOfPage":"https:\/\/jplochocki.github.io\/post\/2022-02-06-pyconnect-na-plecach-gsconnect\/","publisher":{"@type":"Organization","name":"https:\/\/jplochocki.github.io\/","logo":{"@type":"ImageObject","url":"https:\/\/jplochocki.github.io\/","height":60,"width":60}}}</script>
<meta property="og:title" content="PyConnect na plecach GSConnect">
<meta property="og:description" content="Mniej więcej na początku grudnia zainteresowałem się protokołem KDEConnect. Aplikacji tej używałem już od ponad roku - dobrze służyła mi do synchronizacji plików pomiędzy telefonem i komputerem. Coraz bardziej marzyła mi się własna wersja - po stronie komputera. Planowałem jej integrację z własnymi aplikacjami (np. automatyzację pobierania i tagowania nowych zdjęć z moich podróży).">
<meta property="og:url" content="https://jplochocki.github.io/post/2022-02-06-pyconnect-na-plecach-gsconnect/">
<meta property="og:type" content="website">
<meta property="og:site_name" content="/home/systemik/blog">
<meta name=twitter:title content="PyConnect na plecach GSConnect">
<meta name=twitter:description content="Mniej więcej na początku grudnia zainteresowałem się protokołem KDEConnect. Aplikacji tej używałem już od ponad roku - dobrze służyła mi do synchronizacji plików pomiędzy telefonem i komputerem. Coraz …">
<meta name=twitter:card content="summary">
<meta name=generator content="Hugo 0.92.2">
<link rel=alternate href=https://jplochocki.github.io/index.xml type=application/rss+xml title=/home/systemik/blog><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous>
<link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous>
<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://jplochocki.github.io/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://jplochocki.github.io/css/syntax.css><link rel=stylesheet href=https://jplochocki.github.io/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top navbar-custom">
<div class=container-fluid>
<div class=navbar-header>
<button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Nawigacja</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://jplochocki.github.io/>/home/systemik/blog</a>
</div>
<div class="collapse navbar-collapse" id=main-navbar>
<ul class="nav navbar-nav navbar-right">
</ul>
</div>
</div>
</nav>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header class=header-section>
<div class="intro-header no-img">
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<div class=post-heading>
<h1>PyConnect na plecach GSConnect</h1>
<span class=post-meta>
<i class="fas fa-calendar"></i>&nbsp;Opublikowany 06.02.2022
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;
</span>
</div>
</div>
</div>
</div>
</div>
</header>
<div class=container role=main>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<article role=main class=blog-post>
<p>Mniej więcej na początku grudnia zainteresowałem się protokołem <a href="https://play.google.com/store/apps/details?id=org.kde.kdeconnect_tp&hl=pl&gl=US">KDEConnect</a>. Aplikacji tej używałem już od ponad roku - dobrze służyła mi do synchronizacji plików pomiędzy telefonem i komputerem. Coraz bardziej marzyła mi się własna wersja - po stronie komputera. Planowałem jej integrację z własnymi aplikacjami (np. automatyzację pobierania i tagowania nowych zdjęć z moich podróży).</p>
<p>Poznanie samego protokołu <a href="https://play.google.com/store/apps/details?id=org.kde.kdeconnect_tp&hl=pl&gl=US">KDEConnect</a> nie należało jednak do zadań prostych. Dokumentacja samego <a href="https://play.google.com/store/apps/details?id=org.kde.kdeconnect_tp&hl=pl&gl=US">KDEConnect</a> - jest mało czytelna i nie za bogata. W zasadzie więcej o komunikacji musiałem dowiedzieć się z analizy kodu <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect>GSConnect</a> (czyli rozszerzenia do <a href=https://www.gnome.org/>Gnome Shell</a>, które realizuje na komputerze te same zadania, co <a href="https://play.google.com/store/apps/details?id=org.kde.kdeconnect_tp&hl=pl&gl=US">KDEConnect</a>). W końcu udało mi się nawiązać pierwsze połączenia z telefonem - początkowo dla uproszczenia korzystając z parowania urządzenia, jakie wykonał dla mnie sam <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect>GSConnect</a>.</p>
<p>Co mi było potrzebne (poza analizą kodu <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect>GSConnect</a>) - nawiązanie połączenia przez <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect>GSConnect</a>. I jego wyłączenie zaraz po tym - inaczej zajmowałby on port <code>1716</code> potrzebny dla mojej aplikacji.</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>gnome-extensions disable gsconnect@andyholmes.github.io
ps axf | grep gsconnect | grep -v grep | awk <span style=color:#e6db74>&#39;{print &#34;sudo kill -9 &#34; $1}&#39;</span> | sh
</code></pre></td></tr></table>
</div>
</div><p>Rozszerzenie wyłączamy poleceniem <code>gnome-extensions disable</code> (<code>enable</code> pozwoli nam potem na jego włączenie). Musimy jeszcze oddzielnie zabić proces samego rozszerzenia (mający wywołanie w stylu <code>gjs /home/systemik/.local/share/gnome-shell/extensions/gsconnect@andyholmes.github.io/service/daemon.js</code>). Po tym przestanie zajmować ono nam port <code>1716</code> potrzebny do komunikacji z <a href="https://play.google.com/store/apps/details?id=org.kde.kdeconnect_tp&hl=pl&gl=US">KDEConnect</a>.</p>
<p>Z konfiguracji <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect>GSConnect</a> będziemy potrzebowali certyfikatu z kluczem prywatnym dla komunikacji <a href=https://en.wikipedia.org/wiki/Transport_Layer_Security>TLS</a> - są one zapisane w plikach <code>~/.config/gsconnect/certificate.pem</code> i <code>~/.config/gsconnect/private.pem</code>.</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> os.path


GSCONNECT_CERTFILE <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>expanduser(GSCONNECT_CERTFILE)
GSCONNECT_KEYFILE <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>expanduser(GSCONNECT_KEYFILE)

<span style=color:#66d9ef>assert</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(GSCONNECT_CERTFILE) <span style=color:#f92672>and</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(GSCONNECT_KEYFILE)
</code></pre></td></tr></table>
</div>
</div><p>Drugi zestaw danych zawiera konfiguracja <a href=https://en.wikipedia.org/wiki/Dconf>dconf</a> (<code>dconf dump /org/gnome/shell/extensions/gsconnect/</code>) - poniżej wynik skracam tylko do tych danych, które będą nam potrzebne:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#66d9ef>[/]</span>
<span style=color:#a6e22e>devices</span><span style=color:#f92672>=</span><span style=color:#e6db74>[&#39;32151f87b8be9b96&#39;]</span>
<span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;112ab5c3-fd8d-4bcb-ae11-9d08fcad0a05&#39;</span>
<span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;dell&#39;</span>

<span style=color:#66d9ef>[device/32151f87b8be9b96]</span>
<span style=color:#a6e22e>certificate-pem</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;-----BEGIN CERTIFICATE-----...----END CERTIFICATE-----&#39;</span>
<span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Redmi 6A&#39;</span>
<span style=color:#a6e22e>paired</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</code></pre></td></tr></table>
</div>
</div><p>Dane te a naszym kodzie możemy odczytać na dwa sposoby - <a href=https://docs.python.org/3/library/subprocess.html>subprocess</a> i wywołanie <code>dconf</code> (np. <code>dconf read /org/gnome/shell/extensions/gsconnect/id</code>). Lub wykorzystując <a href=https://lazka.github.io/pgi-docs/Gio-2.0/classes/Settings.html>Gio.Settings</a> z <a href=https://pygobject.readthedocs.io/en/latest/>PyGObject</a>. Ten drugi model wydał mi się trochę jednak prostszy (mimo tego, że <a href=https://lazka.github.io/pgi-docs/Gio-2.0/classes/Settings.html>Gio.Settings</a> obsługuje się w sposób mało <em>Python-owy</em>). Przykład odczytywania podstawowych danych:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> gi.repository <span style=color:#f92672>import</span> Gio


gsconnect_config <span style=color:#f92672>=</span> Gio<span style=color:#f92672>.</span>Settings<span style=color:#f92672>.</span>new_with_path(
    <span style=color:#e6db74>&#39;org.gnome.Shell.Extensions.GSConnect.Device&#39;</span>,
    <span style=color:#e6db74>&#39;/org/gnome/shell/extensions/gsconnect/&#39;</span>)
GSCONNECT_DEVICE_ID <span style=color:#f92672>=</span> gsconnect_config<span style=color:#f92672>.</span>get_string(<span style=color:#e6db74>&#39;id&#39;</span>)
GSCONNECT_DEVICE_NAME <span style=color:#f92672>=</span> gsconnect_config<span style=color:#f92672>.</span>get_string(<span style=color:#e6db74>&#39;name&#39;</span>)

<span style=color:#75715e># lista dostępnych ID połączeń</span>
gsconnect_config <span style=color:#f92672>=</span> Gio<span style=color:#f92672>.</span>Settings<span style=color:#f92672>.</span>new_with_path(
    <span style=color:#e6db74>&#39;org.gnome.Shell.Extensions.GSConnect&#39;</span>,
    <span style=color:#e6db74>&#39;/org/gnome/shell/extensions/gsconnect/&#39;</span>)
GSCONNECT_KNOWN_DEVICES <span style=color:#f92672>=</span> list(gsconnect_config<span style=color:#f92672>.</span>get_value(<span style=color:#e6db74>&#39;devices&#39;</span>))
</code></pre></td></tr></table>
</div>
</div><p>Przy wykonywaniu połączenia będziemy na pewno chcieli wydobyć certyfikat drugiej strony:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># remote_deviceId - to id urządzenia przysłany w pakiecie identyfikacji i zapisany w dconf</span>

gsconnect_config <span style=color:#f92672>=</span> Gio<span style=color:#f92672>.</span>Settings<span style=color:#f92672>.</span>new_with_path(
    <span style=color:#e6db74>&#39;org.gnome.Shell.Extensions.GSConnect.Device&#39;</span>,
    <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;/org/gnome/shell/extensions/gsconnect/device/</span><span style=color:#e6db74>{</span>remote_deviceId<span style=color:#e6db74>}</span><span style=color:#e6db74>/&#39;</span>)

ssl_context<span style=color:#f92672>.</span>load_verify_locations(
    cadata<span style=color:#f92672>=</span>ssl<span style=color:#f92672>.</span>PEM_cert_to_DER_cert(
        gsconnect_config<span style=color:#f92672>.</span>get_string(<span style=color:#e6db74>&#39;certificate-pem&#39;</span>)))
</code></pre></td></tr></table>
</div>
</div><p>Analiza <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect>GSConnect</a> (a dokładniej plików <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect/blob/master/src/service/core.js>src/service/core.js</a> i <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect/blob/master/src/service/backends/lan.js>src/service/backends/lan.js</a>) naprowadziła mnie na najbardziej podstawowy mechanizm nawiązywania połączenia:</p>
<ol>
<li>Otwieramy nasłuch <a href=https://en.wikipedia.org/wiki/User_Datagram_Protocol>UDP</a> na porcie <code>1716</code> (od wszystkich), czekamy na pakiet <code>kdeconnect.identity</code>. Jeśli jego nadawca (<code>body.deviceId</code>) jest nam znany - przechodzimy dalej.</li>
<li>Otwieramy połączenie (<a href=https://en.wikipedia.org/wiki/Transmission_Control_Protocol>TCP</a> na porcie <code>1716</code>) z nadawcą tego pakietu.</li>
<li>Wysyłamy własny pakiet identyfikacji (<code>kdeconnect.identity</code> z naszymi danymi).</li>
<li>Zmieniamy zwykłe gniazdo <a href=https://en.wikipedia.org/wiki/Transmission_Control_Protocol>TCP</a> na <a href=https://en.wikipedia.org/wiki/Transport_Layer_Security>TLS</a> (ale z <code>server_side=True</code> - mimo tego, że to my nawiązaliśmy połączenie, to mamy dalej zachować się, jak serwer).</li>
<li>I możemy się cieszyć połączeniem z naszym <a href="https://play.google.com/store/apps/details?id=org.kde.kdeconnect_tp&hl=pl&gl=US">KDEConnect</a>.</li>
</ol>
<p>W swoim kodzie (<a href=https://gist.github.com/jplochocki/1a7a206ae7e2b0f2243b1fa473b31003>pyconnect.py</a>) będę posługiwał się biblioteką <a href=https://anyio.readthedocs.io/en/stable/>AnyIO</a>, która mocno upraszcza działanie z natywnym <a href=https://en.wikipedia.org/wiki/Transmission_Control_Protocol>TCP</a> i <a href=https://en.wikipedia.org/wiki/User_Datagram_Protocol>UDP</a>, a jednocześnie umożliwia działanie w <a href=https://docs.python.org/3/library/asyncio.html>asyncio</a>.</p>
<p>Nasłuch <a href=https://en.wikipedia.org/wiki/User_Datagram_Protocol>UDP</a> nie jest trudnym zadaniem, używamy <a href=https://anyio.readthedocs.io/en/stable/api.html#anyio.create_udp_socket>anyio.create_udp_socket()</a>, pamiętając o <code>local_host='255.255.255.255'</code> (czyli nasłuch na <a href=https://pl.wikipedia.org/wiki/Broadcast>broadcast</a>) i odpowiednim <code>local_port</code> (<code>1716</code>).</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> anyio


KDE_CONNECT_DEFAULT_PORT <span style=color:#f92672>=</span> <span style=color:#ae81ff>1716</span>


<span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wait_for_incoming_id</span>(main_group):
    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> <span style=color:#66d9ef>await</span> anyio<span style=color:#f92672>.</span>create_udp_socket(
            family<span style=color:#f92672>=</span>socket<span style=color:#f92672>.</span>AF_INET, local_host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;255.255.255.255&#39;</span>,
            local_port<span style=color:#f92672>=</span>KDE_CONNECT_DEFAULT_PORT) <span style=color:#66d9ef>as</span> udp:
        <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>for</span> data, (host, port) <span style=color:#f92672>in</span> udp:
            <span style=color:#66d9ef>try</span>:
                pack <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(data<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>))
            <span style=color:#66d9ef>except</span> json<span style=color:#f92672>.</span>JSONDecodeError:
                log<span style=color:#f92672>.</span>exception((<span style=color:#e6db74>&#39;wait_for_incoming_id(): malformed id packet &#39;</span>
                               <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>data<span style=color:#e6db74>}</span><span style=color:#e6db74> from </span><span style=color:#e6db74>{</span>host<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>port<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>))
                <span style=color:#66d9ef>return</span>

            <span style=color:#66d9ef>if</span> pack[<span style=color:#e6db74>&#39;type&#39;</span>] <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;kdeconnect.identity&#39;</span> <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;deviceId&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> pack[<span style=color:#e6db74>&#39;body&#39;</span>]:  <span style=color:#75715e># noqa</span>
                log<span style=color:#f92672>.</span>warning(
                    (<span style=color:#e6db74>&#39;wait_for_incoming_id(): identity packet without &#39;</span>
                     <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;body.deviceId or unknown type</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>{</span>pack<span style=color:#e6db74>=}</span><span style=color:#e6db74>&#39;</span>))
                <span style=color:#66d9ef>return</span>

            dev_id <span style=color:#f92672>=</span> pack[<span style=color:#e6db74>&#39;body&#39;</span>][<span style=color:#e6db74>&#39;deviceId&#39;</span>]
            known <span style=color:#f92672>=</span> dev_id <span style=color:#f92672>in</span> GSCONNECT_KNOWN_DEVICES
            log<span style=color:#f92672>.</span>info((<span style=color:#e6db74>&#39;wait_for_incoming_id(): id packet received from &#39;</span>
                      <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>pack[<span style=color:#e6db74>&#34;body&#34;</span>][<span style=color:#e6db74>&#34;deviceName&#34;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74> / </span><span style=color:#e6db74>{</span>dev_id<span style=color:#e6db74>}</span><span style=color:#e6db74> (IP: </span><span style=color:#e6db74>{</span>host<span style=color:#e6db74>}</span><span style=color:#e6db74>)&#39;</span>
                      <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>known<span style=color:#e6db74>=}</span><span style=color:#e6db74>&#39;</span>))

            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> known <span style=color:#f92672>or</span> dev_id <span style=color:#f92672>==</span> GSCONNECT_DEVICE_ID <span style=color:#f92672>or</span> dev_id <span style=color:#f92672>in</span> CONNECTED_DEVICES:  <span style=color:#75715e># noqa</span>
                <span style=color:#66d9ef>return</span>

            main_group<span style=color:#f92672>.</span>start_soon(device_connection_task, pack, host)
</code></pre></td></tr></table>
</div>
</div><p>Odbierany pakiet będzie miał formę <a href=https://en.wikipedia.org/wiki/JSON>JSON</a> - zajmującego <strong>tylko jedną linię</strong>. Jego przykładowa wartość wygląda następująco:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#ae81ff>1644153455113</span>,
    <span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;kdeconnect.identity&#34;</span>,
    <span style=color:#f92672>&#34;body&#34;</span>:{
        <span style=color:#f92672>&#34;deviceId&#34;</span>:<span style=color:#e6db74>&#34;32151f87b8be9b96&#34;</span>,
        <span style=color:#f92672>&#34;deviceName&#34;</span>:<span style=color:#e6db74>&#34;Redmi 6A&#34;</span>,
        <span style=color:#f92672>&#34;protocolVersion&#34;</span>:<span style=color:#ae81ff>7</span>,
        <span style=color:#f92672>&#34;deviceType&#34;</span>:<span style=color:#e6db74>&#34;phone&#34;</span>,
        <span style=color:#f92672>&#34;incomingCapabilities&#34;</span>:[
            <span style=color:#e6db74>&#34;kdeconnect.telephony.request_mute&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.notification&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.ping&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.notification.reply&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.notification.action&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.share.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.bigscreen.stt&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.clipboard.connect&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.runcommand&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.connectivity_report.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.contacts.request_all_uids_timestamps&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.sms.request_conversations&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.telephony.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.mpris&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.sms.request_conversation&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.findmyphone.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.sms.request_attachment&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.systemvolume&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.mousepad.keyboardstate&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.sftp.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.share.request.update&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.notification.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.mousepad.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.photo.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.sms.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.contacts.request_vcards_by_uid&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.mpris.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.battery.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.battery&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.clipboard&#34;</span>
        ],
        <span style=color:#f92672>&#34;outgoingCapabilities&#34;</span>:[
            <span style=color:#e6db74>&#34;kdeconnect.telephony&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.notification&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.contacts.response_uids_timestamps&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.ping&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.share.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.bigscreen.stt&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.clipboard.connect&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.connectivity_report&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.sftp&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.sms.attachment_file&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.systemvolume.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.sms.messages&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.mpris&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.findmyphone.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.mousepad.keyboardstate&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.contacts.response_vcards&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.notification.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.mousepad.echo&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.mousepad.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.presenter&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.photo&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.runcommand.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.mpris.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.battery.request&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.battery&#34;</span>,
            <span style=color:#e6db74>&#34;kdeconnect.clipboard&#34;</span>
        ],
        <span style=color:#f92672>&#34;tcpPort&#34;</span>:<span style=color:#ae81ff>1716</span>
    }
}
</code></pre></td></tr></table>
</div>
</div><p>Co warto wiedzieć o pakietach - mają one typ (<code>type</code> - na tym etapie interesują nas tylko pakiety <code>kdeconnect.identity</code>). <code>id</code> to po prostu aktualny czas. Najciekawsze pola w <code>body</code> to <code>deviceId</code> i <code>deviceName</code> (oba będą zgodne z danymi z konfiguracji). <code>incomingCapabilities</code> i <code>outgoingCapabilities</code> to lista pluginów, jakie mogę być obsługiwane - my na początku skrócimy ją do <code>kdeconnect.share.request</code>, czyli umożliwimy tylko przesyłanie plików. W kwestii <code>tcpPort</code> - nie widziałem nigdy, aby był używany jakiś inny, niż domyślny <code>1716</code>, choć kod <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect>GSConnect</a> trzyma się tego, aby nawiązywać połączenie na porcie podawanym przez ten pakiet.</p>
<p>Pakiet próbujemy odczytać, potem - sprawdzamy czy ma on wymagany typ i interesujące nas <code>body.deviceId</code> (z <code>ID</code>, z którym nawiązał wcześniej połączenie <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect>GSConnect</a>, a my te dane przechwyciliśmy z jego konfiguracji). Jak już wszystkie warunki zostaną spełnione - przechodzimy do wystartowania zadania <code>device_connection_task()</code>, które ogarnie nam temat połączenia <a href=https://en.wikipedia.org/wiki/Transmission_Control_Protocol>TCP</a>.</p>
<p>Połączenie to nawiązujemy za pomocą <a href=https://anyio.readthedocs.io/en/stable/api.html#anyio.connect_tcp>anyio.connect_tcp()</a>.</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>
<span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>device_connection_task</span>(id_packet, remote_ip):
    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> <span style=color:#66d9ef>await</span> anyio<span style=color:#f92672>.</span>connect_tcp(remote_ip, KDE_CONNECT_DEFAULT_PORT) <span style=color:#66d9ef>as</span> sock:  <span style=color:#75715e># noqa</span>
</code></pre></td></tr></table>
</div>
</div><p>Następnie musimy w nim wysłać nasz pakiet identyfikacji:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#ae81ff>1644153455971504483</span>,
    <span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;kdeconnect.identity&#34;</span>,
    <span style=color:#f92672>&#34;body&#34;</span>:{
        <span style=color:#f92672>&#34;deviceId&#34;</span>:<span style=color:#e6db74>&#34;112ab5c3-fd8d-4bcb-ae11-9d08fcad0a05&#34;</span>,
        <span style=color:#f92672>&#34;deviceName&#34;</span>:<span style=color:#e6db74>&#34;dell&#34;</span>,
        <span style=color:#f92672>&#34;deviceType&#34;</span>:<span style=color:#e6db74>&#34;laptop&#34;</span>,
        <span style=color:#f92672>&#34;protocolVersion&#34;</span>:<span style=color:#ae81ff>7</span>,
        <span style=color:#f92672>&#34;incomingCapabilities&#34;</span>:[
            <span style=color:#e6db74>&#34;kdeconnect.share.request&#34;</span>
        ],
        <span style=color:#f92672>&#34;outgoingCapabilities&#34;</span>:[
            <span style=color:#e6db74>&#34;kdeconnect.share.request&#34;</span>
        ],
        <span style=color:#f92672>&#34;tcpPort&#34;</span>:<span style=color:#ae81ff>1716</span>
    }
}
</code></pre></td></tr></table>
</div>
</div><p><code>body.deviceId</code> i <code>body.deviceName</code> odczytaliśmy wcześniej z konfiguracji <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect>GSConnect</a>. <code>body.incomingCapabilities</code> i <code>body.outgoingCapabilities</code> zostały mocno skrócone - w pierwszej wersji chciałem mieć tylko przesyłanie plików (plugin <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect/blob/master/src/service/plugins/share.js>src/service/plugins/share.js</a> wymagający tylko wartości <code>kdeconnect.share.request</code>). Generowanie tego pakietu w kodzie wygląda następująco:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>PROTOCOL_VERSION <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>
INCOMING_CAPABILITIES <span style=color:#f92672>=</span> [
    <span style=color:#e6db74>&#39;kdeconnect.share.request&#39;</span>,
]
OUTGOING_CAPABILITIES <span style=color:#f92672>=</span> [
    <span style=color:#e6db74>&#39;kdeconnect.share.request&#39;</span>,
]


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>generate_my_identity</span>():
    <span style=color:#66d9ef>return</span> {
        <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;kdeconnect.identity&#39;</span>,
        <span style=color:#e6db74>&#39;body&#39;</span>: {
            <span style=color:#e6db74>&#39;deviceId&#39;</span>: GSCONNECT_DEVICE_ID,
            <span style=color:#e6db74>&#39;deviceName&#39;</span>: GSCONNECT_DEVICE_NAME,
            <span style=color:#e6db74>&#39;deviceType&#39;</span>: <span style=color:#e6db74>&#39;laptop&#39;</span>,
            <span style=color:#e6db74>&#39;protocolVersion&#39;</span>: PROTOCOL_VERSION,
            <span style=color:#e6db74>&#39;incomingCapabilities&#39;</span>: INCOMING_CAPABILITIES,
            <span style=color:#e6db74>&#39;outgoingCapabilities&#39;</span>: OUTGOING_CAPABILITIES,
            <span style=color:#e6db74>&#39;tcpPort&#39;</span>: KDE_CONNECT_DEFAULT_PORT
        }
    }


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>prepare_to_send</span>(pack):
    pack2 <span style=color:#f92672>=</span> pack<span style=color:#f92672>.</span>copy()
    pack2[<span style=color:#e6db74>&#39;id&#39;</span>] <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time_ns()
    <span style=color:#66d9ef>return</span> (json<span style=color:#f92672>.</span>dumps(pack2) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)


<span style=color:#75715e># wysyłanie w device_connection_task()</span>
        <span style=color:#66d9ef>await</span> sock<span style=color:#f92672>.</span>send(prepare_to_send(generate_my_identity()))
</code></pre></td></tr></table>
</div>
</div><p>Po wysłaniu pakietu identyfikacji - musimy przekształcić nasze gniazdo w <a href=https://en.wikipedia.org/wiki/Transport_Layer_Security>TLS</a> (za pomocą <a href=https://anyio.readthedocs.io/en/stable/api.html#anyio.streams.tls.TLSStream.wrap>TLSStream.wrap()</a> z <a href=https://anyio.readthedocs.io/en/stable/>AnyIO</a>, pamiętając, że protokół <a href="https://play.google.com/store/apps/details?id=org.kde.kdeconnect_tp&hl=pl&gl=US">KDEConnect</a> wymaga od nas zachowywania się jak strona serwera - <code>server_side=True</code>). Kontekst <a href=https://en.wikipedia.org/wiki/Transport_Layer_Security>TLS</a> - musi zawierać pliki certyfikatu i klucza przechwycone z <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect>GSConnect</a> i mieć załadowany certyfikat urządzenia (odczytany z konfiguracji <a href=https://github.com/GSConnect/gnome-shell-extension-gsconnect>GSConnect</a>):</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> anyio.streams.tls <span style=color:#f92672>import</span> TLSStream, TLSListener


    <span style=color:#75715e># ...</span>
    remote_deviceId <span style=color:#f92672>=</span> id_packet[<span style=color:#e6db74>&#39;body&#39;</span>][<span style=color:#e6db74>&#39;deviceId&#39;</span>]

    ssl_context <span style=color:#f92672>=</span> ssl<span style=color:#f92672>.</span>create_default_context(ssl<span style=color:#f92672>.</span>Purpose<span style=color:#f92672>.</span>CLIENT_AUTH)
    ssl_context<span style=color:#f92672>.</span>load_cert_chain(GSCONNECT_CERTFILE, GSCONNECT_KEYFILE)
    ssl_context<span style=color:#f92672>.</span>verify_flags <span style=color:#f92672>=</span> ssl<span style=color:#f92672>.</span>CERT_REQUIRED

    gsconnect_config <span style=color:#f92672>=</span> Gio<span style=color:#f92672>.</span>Settings<span style=color:#f92672>.</span>new_with_path(
        <span style=color:#e6db74>&#39;org.gnome.Shell.Extensions.GSConnect.Device&#39;</span>,
        <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;/org/gnome/shell/extensions/gsconnect/device/</span><span style=color:#e6db74>{</span>remote_deviceId<span style=color:#e6db74>}</span><span style=color:#e6db74>/&#39;</span>)

    ssl_context<span style=color:#f92672>.</span>load_verify_locations(
        cadata<span style=color:#f92672>=</span>ssl<span style=color:#f92672>.</span>PEM_cert_to_DER_cert(
            gsconnect_config<span style=color:#f92672>.</span>get_string(<span style=color:#e6db74>&#39;certificate-pem&#39;</span>)))

    <span style=color:#75715e># ...</span>
    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> <span style=color:#66d9ef>await</span> anyio<span style=color:#f92672>.</span>connect_tcp(remote_ip, KDE_CONNECT_DEFAULT_PORT) <span style=color:#66d9ef>as</span> sock:  <span style=color:#75715e># noqa</span>
        <span style=color:#75715e># ... po wysłaniu pakietu ID</span>

        ssock <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> TLSStream<span style=color:#f92672>.</span>wrap(sock, server_side<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
                                     ssl_context<span style=color:#f92672>=</span>ssl_context)
</code></pre></td></tr></table>
</div>
</div><p>Po poprawnym przekształceniu połączenia na <a href=https://en.wikipedia.org/wiki/Transport_Layer_Security>TLS</a> - możemy czekać na pakiety od <a href="https://play.google.com/store/apps/details?id=org.kde.kdeconnect_tp&hl=pl&gl=US">KDEConnect</a>. Dla uproszczenie użyłem <a href=https://anyio.readthedocs.io/en/stable/api.html#anyio.streams.buffered.BufferedByteReceiveStream>BufferedByteReceiveStream</a>, który ułatwia czekanie na koniec pakietu - każdy pakiet to <a href=https://en.wikipedia.org/wiki/JSON>JSON</a> przesyłany w <strong>jednej linii</strong> - czekamy więc na kolejne <code>'\n'</code>.</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> anyio.streams.buffered <span style=color:#f92672>import</span> BufferedByteReceiveStream

        <span style=color:#75715e># ...</span>
        bssock <span style=color:#f92672>=</span> BufferedByteReceiveStream(ssock)
        
        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
            pack_data <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> bssock<span style=color:#f92672>.</span>receive_until(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>, <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span>)

            <span style=color:#66d9ef>try</span>:
                pack <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(pack_data)
            <span style=color:#66d9ef>except</span> json<span style=color:#f92672>.</span>JSONDecodeError:
                log<span style=color:#f92672>.</span>exception(
                    (<span style=color:#e6db74>&#39;device_connection_task(): Error while decoding &#39;</span>
                     <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;packet / </span><span style=color:#e6db74>{</span>pack_data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>))
                <span style=color:#66d9ef>continue</span>
            log<span style=color:#f92672>.</span>debug(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;device_connection_task(): Packet </span><span style=color:#e6db74>{</span>pack_data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
            
            
            <span style=color:#75715e># obsługa samego pakietu</span>

</code></pre></td></tr></table>
</div>
</div><p>Wspominany tu kod znajduje się w pliku <a href=https://gist.github.com/jplochocki/1a7a206ae7e2b0f2243b1fa473b31003>pyconnect.py</a>.</p>
<p>W <a href=https://jplochocki.github.io/post/2022-02-20-pyconnect-i-pliki/>następnym poście</a> przedstawię mechanizm odbierania i wysyłania plików.</p>
<div class=blog-tags>
<a href=https://jplochocki.github.io//tags/kdeconnect/>KDEConnect</a>&nbsp;
<a href=https://jplochocki.github.io//tags/gsconnect/>GSConnect</a>&nbsp;
<a href=https://jplochocki.github.io//tags/python/>Python</a>&nbsp;
<a href=https://jplochocki.github.io//tags/ssl/>SSL</a>&nbsp;
<a href=https://jplochocki.github.io//tags/tls/>TLS</a>&nbsp;
<a href=https://jplochocki.github.io//tags/anyio/>AnyIO</a>&nbsp;
<a href=https://jplochocki.github.io//tags/gnome-shell/>Gnome Shell</a>&nbsp;
</div>
</article>
<ul class="pager blog-pager">
<li class=previous>
<a href=https://jplochocki.github.io/post/2022-02-02-diabel-tkwi-w-certyfikatach/ data-toggle=tooltip data-placement=top title="Diabeł tkwi w... certyfikatach">&larr; Poprzedni</a>
</li>
<li class=next>
<a href=https://jplochocki.github.io/post/2022-02-20-pyconnect-i-pliki/ data-toggle=tooltip data-placement=top title="PyConnect i pliki">Następny &rarr;</a>
</li>
</ul>
</div>
</div>
</div>
<footer>
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<ul class="list-inline text-center footer-links">
</ul>
<p class="credits copyright text-muted">
&nbsp;&bull;&nbsp;&copy;
2022
&nbsp;&bull;&nbsp;
<a href=https://jplochocki.github.io/>/home/systemik/blog</a>
</p>
<p class="credits theme-by text-muted">
<a href=https://gohugo.io>Hugo v0.92.2</a> napędzany &nbsp;&bull;&nbsp; Motyw <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> przystosowany od <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>
</p>
</div>
</div>
</div>
</footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script>
<script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://jplochocki.github.io/js/main.js></script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://jplochocki.github.io/js/load-photoswipe.js></script>
</body>
</html>